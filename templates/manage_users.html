{% extends "base.html" %}

{% block title %}User Management - Lumen ERP{% endblock %}

{% block content %}
<div style="margin-bottom: 50px;">
    <h1 class="hero-text" style="margin-bottom: 10px;">User Management</h1>
    <p style="color: var(--text-secondary); font-weight: 700;">Add and manage staff accounts.</p>
</div>

<div class="nm-card" style="margin-bottom: 60px; padding: 50px;">
    <h2
        style="font-weight: 900; margin-bottom: 30px; letter-spacing: -1px; display: flex; align-items: center; gap: 15px;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="3">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
        </svg>
        Add New User
    </h2>

    <form action="/admin/users" method="POST">
        <div class="grid-3" style="gap: 20px; margin-bottom: 20px;">
            <div>
                <label
                    style="display: block; margin-bottom: 10px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase;">Username</label>
                <input type="text" name="username" class="nm-input" placeholder="e.g. john_doe" required>
            </div>
            <div>
                <label
                    style="display: block; margin-bottom: 10px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase;">Password</label>
                <input type="password" name="password" class="nm-input" required>
            </div>
            <div>
                <label
                    style="display: block; margin-bottom: 10px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase;">Select
                    Role</label>
                <select name="role" class="nm-input" id="role-select" required>
                    <option value="HOD">Department HOD</option>
                    <option value="Faculty">Faculty Teacher</option>
                </select>
            </div>
        </div>

        <!-- Dynamic Fields -->
        <div id="hod-fields" style="display: none; margin-bottom: 20px;">
            <div class="grid-2">
                <div>
                    <label
                        style="display: block; margin-bottom: 10px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase;">Department</label>
                    <input type="text" name="hod_department" class="nm-input" placeholder="e.g. Engineering">
                </div>
                <div>
                    <label
                        style="display: block; margin-bottom: 10px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase;">Position</label>
                    <select name="hod_rank" class="nm-input">
                        <option value="HOD">HOD</option>
                        <option value="Asst_HOD">Assistant HOD</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="faculty-fields" style="display: none; margin-bottom: 20px;">
            <div class="grid-3" style="gap: 20px;">
                <div>
                    <label
                        style="display: block; margin-bottom: 10px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase;">Department</label>
                    <select name="faculty_department" class="nm-input" id="faculty_department" required>
                        <option value="">Select department</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}">{{ dept }}</option>
                        {% endfor %}
                    </select>
                    <p style="margin-top: 6px; font-size: 0.7rem; opacity: 0.8;">Required. Manager is auto-assigned from this department if not selected below.</p>
                </div>
                <div>
                    <label
                        style="display: block; margin-bottom: 10px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase;">Manager (optional)</label>
                    <select name="faculty_hod_id" class="nm-input" id="faculty_hod_id">
                        <option value="">Auto-assign from department</option>
                        {% for hod in hods %}
                        <option value="{{ hod.id }}" data-department="{{ hod.department }}">{{ hod.user.username }} ({{ hod.department }} - {{ hod.rank }})</option>
                        {% endfor %}
                    </select>
                    <p style="margin-top: 6px; font-size: 0.7rem; opacity: 0.8;">Pick a manager or leave as auto to use the department HOD.</p>
                </div>
                <div>
                    <label
                        style="display: block; margin-bottom: 10px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase;">Designation</label>
                    <input type="text" name="designation" class="nm-input" placeholder="e.g. Professor">
                </div>
            </div>
        </div>

        <button type="submit" class="nm-btn primary" style="width: 100%; padding: 20px;">Create Account</button>
    </form>
</div>

<script>
    const roleSelect = document.getElementById('role-select');
    const hodFields = document.getElementById('hod-fields');
    const facultyFields = document.getElementById('faculty-fields');

    const facultyDeptSelect = document.getElementById('faculty_department');
    const facultyHodSelect = document.getElementById('faculty_hod_id');
    function updateVisibility() {
        hodFields.style.display = roleSelect.value === 'HOD' ? 'block' : 'none';
        facultyFields.style.display = roleSelect.value === 'Faculty' ? 'block' : 'none';
        if (facultyDeptSelect) facultyDeptSelect.required = roleSelect.value === 'Faculty';
    }
    function updateManagerFromDepartment() {
        if (!facultyHodSelect || !facultyDeptSelect) return;
        var dept = facultyDeptSelect.value;
        if (!dept) { facultyHodSelect.value = ''; return; }
        var options = facultyHodSelect.querySelectorAll('option[data-department]');
        for (var i = 0; i < options.length; i++) {
            if (options[i].getAttribute('data-department') === dept) {
                facultyHodSelect.value = options[i].value;
                return;
            }
        }
        facultyHodSelect.value = '';
    }
    if (facultyDeptSelect) facultyDeptSelect.addEventListener('change', updateManagerFromDepartment);

    roleSelect.addEventListener('change', updateVisibility);
    updateVisibility();
</script>
</div>

<div class="nm-table-container">
    <div style="padding: 20px 10px 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <h2 style="font-weight: 900; letter-spacing: -1px;">User List</h2>
        <form method="get" action="/admin/users" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <label style="font-weight: 700; font-size: 0.75rem; color: var(--text-secondary);">Role:</label>
            <select name="filter_role" class="nm-input" style="padding: 10px 14px; min-width: 140px;" onchange="this.form.submit()">
                <option value="">All roles</option>
                <option value="Admin" {{ 'selected' if filter_role == 'Admin' else '' }}>Admin</option>
                <option value="HOD" {{ 'selected' if filter_role == 'HOD' else '' }}>HOD</option>
                <option value="Faculty" {{ 'selected' if filter_role == 'Faculty' else '' }}>Faculty</option>
                <option value="Student" {{ 'selected' if filter_role == 'Student' else '' }}>Student</option>
            </select>
            <label style="font-weight: 700; font-size: 0.75rem; color: var(--text-secondary);">Department:</label>
            <select name="filter_department" class="nm-input" style="padding: 10px 14px; min-width: 160px;" onchange="this.form.submit()">
                <option value="">All departments</option>
                {% for d in all_departments %}
                <option value="{{ d }}" {{ 'selected' if filter_department == d else '' }}>{{ d }}</option>
                {% endfor %}
            </select>
            {% if filter_role or filter_department %}
            <a href="/admin/users" class="nm-btn" style="padding: 10px 16px; font-size: 0.8rem;">Clear filters</a>
            {% endif %}
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Department</th>
                <th>Manager</th>
                <th style="text-align: right;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for a in admins %}
            <tr>
                <td style="font-weight: 900; font-size: 1.1rem; color: var(--accent-color);">{{ a.username }}</td>
                <td><span class="nm-badge" style="font-size: 0.65rem; background: var(--accent-color); color: white;">Admin</span></td>
                <td style="opacity: 0.7;">—</td>
                <td style="opacity: 0.5;">—</td>
                <td style="text-align: right;">
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <a href="/admin/user/edit/{{ a.id }}" class="nm-btn" style="padding: 8px 16px; font-size: 0.7rem;">Edit</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% for h in hods %}
            <tr>
                <td style="font-weight: 900; font-size: 1.1rem; color: var(--accent-color);">{{ h.user.username }}</td>
                <td><span class="nm-badge" style="font-size: 0.65rem; background: var(--text-primary); color: white;">{{ h.rank }}</span></td>
                <td style="opacity: 0.7; font-weight: 800;">{{ h.department }}</td>
                <td style="opacity: 0.5; font-weight: 600;">—</td>
                <td style="text-align: right;">
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <a href="/admin/user/edit/{{ h.user.id }}" class="nm-btn" style="padding: 8px 16px; font-size: 0.7rem;">Edit</a>
                        <a href="/admin/user/delete/{{ h.user.id }}" class="nm-btn" style="padding: 8px 16px; font-size: 0.7rem; color: #ff6b6b;" onclick="return confirm('Delete HOD Account?')">Delete</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% for f in faculty %}
            <tr>
                <td style="font-weight: 800; font-size: 1.1rem;">{{ f.user.username }}</td>
                <td><span class="nm-badge" style="font-size: 0.65rem;">Faculty</span></td>
                <td style="opacity: 0.7; font-weight: 700;">{{ f.department }}</td>
                <td style="opacity: 0.7; font-weight: 700;">{{ f.hod.user.username if f.hod else 'Unassigned' }}</td>
                <td style="text-align: right;">
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <a href="/admin/user/edit/{{ f.user.id }}" class="nm-btn" style="padding: 8px 16px; font-size: 0.7rem;">Edit</a>
                        <a href="/admin/user/delete/{{ f.user.id }}" class="nm-btn" style="padding: 8px 16px; font-size: 0.7rem; color: #ff6b6b;" onclick="return confirm('Delete this faculty account?')">Delete</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% for s in students %}
            <tr>
                <td style="font-weight: 800; font-size: 1.1rem;">{{ s.username }}</td>
                <td><span class="nm-badge" style="font-size: 0.65rem;">Student</span></td>
                <td style="opacity: 0.7;">{{ s.student_profile.department if s.student_profile else '—' }}</td>
                <td style="opacity: 0.7;">{{ s.student_profile.hod.user.username if (s.student_profile and s.student_profile.hod) else '—' }}</td>
                <td style="text-align: right;">
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <a href="/admin/user/edit/{{ s.id }}" class="nm-btn" style="padding: 8px 16px; font-size: 0.7rem;">Edit</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}